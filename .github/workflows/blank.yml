name: CI

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - uses: actions/setup-node@v1
      with:
        node-version: '12.x'

    - name: Setup Hexo & COS env
      env:
        SecretId: ${{ secrets.SecretId }}
        SecretKey: ${{ secrets.SecretKey }}

      run: |
        npm install hexo-cli -g
        npm install
        sed -i "s/SecretId/${SecretId}/" _config.yml
        sed -i "s/SecretKey/${SecretKey}/" _config.yml

    - name: Deploy to COS
      run: |
        hexo clean && hexo g && hexo d

  push-to-mirror:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - name: Push to Coding
        run: |
          remote_repo="https://${CODING_USERNAME}:${CODING_PASSWORD}https://e.coding.net/js-coder/blog/Blog.git"
          git remote add coding "${remote_repo}"
          git show-ref # useful for debugging
          git branch --verbose
          # publish all
          git push --all --force coding
          git push --tags --force coding
        env:
          CODING_REPOSITORY: ${secrets.CODING_REPOSITORY}
          CODING_USERNAME: ${{ secrets.CODING_USERNAME }}
          CODING_PASSWORD: ${{ secrets.CODING_PASSWORD }}
